<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Carte des trajets</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
  <style>
    #map { height: 500px; }
  </style>
</head>
<body>

<h2>Carte des trajets</h2>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
const map = L.map("map").setView([43.6001, 1.4419], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

async function loadTrackData() {
  try {
    const response = await fetch(
      "https://lilied-subprofessionally-mafalda.ngrok-free.dev/api/measurements",
      {
        headers: {
          "X-API-KEY": "openbikecle",
          "ngrok-skip-browser-warning": "true"
        }
      }
    );

    if (!response.ok) {
      throw new Error("HTTP " + response.status);
    }

    const trackData = await response.json();

    if (!Array.isArray(trackData)) {
      throw new Error("Réponse non valide");
    }

    const coords = trackData.map(p => [p.lat, p.lng]);
    L.polyline(coords, { color: "blue" }).addTo(map);

    trackData.forEach(p => {
      L.marker([p.lat, p.lng]).addTo(map)
        .bindPopup(`Vitesse: ${p.speed_kmh} km/h`);
    });

  } catch (e) {
    console.error(e);
    alert("Erreur de chargement des données");
  }
}

loadTrackData();
</script>
</body>
</html>