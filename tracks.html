<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tracks</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body class="iframe-page">
<div id="container">
  <div id="trace-list">
    <h3>Tracks</h3>
    <div id="list"></div>
  </div>
  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const API_URL = "https://lilied-subprofessionally-mafalda.ngrok-free.dev/api/measurements";
const API_KEY = "openbikecle";
const MAX_GAP_SECONDS = 5;

const map = L.map("map").setView([43.6001, 1.4419], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "Â© OpenStreetMap" }).addTo(map);

let currentLayer = null;

function toTimestamp(p) { return new Date(p.year, p.month - 1, p.day, p.hour, p.minute, p.second).getTime(); }

function groupIntoTraces(points, maxGapSeconds) {
  const traces = [];
  let current = [];
  const sorted = [...points].sort((a,b) => toTimestamp(a) - toTimestamp(b));
  for (let i=0; i<sorted.length; i++) {
    if (current.length === 0) { current.push(sorted[i]); continue; }
    const gap = (toTimestamp(sorted[i]) - toTimestamp(current[current.length-1]))/1000;
    if (gap > maxGapSeconds) { traces.push(current); current = []; }
    current.push(sorted[i]);
  }
  if (current.length) traces.push(current);
  return traces;
}

function showTrace(trace) {
  if (currentLayer) map.removeLayer(currentLayer);
  const coords = trace.map(p => [p.lat, p.lng]);
  currentLayer = L.polyline(coords, { color: "#2563eb", weight: 4 }).addTo(map);
  map.fitBounds(currentLayer.getBounds());
}

async function loadTraces() {
  try {
    const response = await fetch(API_URL, { headers: { "X-API-KEY": API_KEY, "ngrok-skip-browser-warning": "true" } });
    let data = await response.json();
    data = data.filter(p => p.valid === 1);
    const traces = groupIntoTraces(data, MAX_GAP_SECONDS);
    const list = document.getElementById("list");
    list.innerHTML = ""; // Vider avant de charger
    
    traces.forEach((trace) => {
      const btn = document.createElement("button");
      btn.className = "trace-item";
      btn.innerText = `${trace[0].day}/${trace[0].month} - ${trace.length} pts`;
      btn.onclick = () => showTrace(trace);
      list.appendChild(btn);
    });
  } catch(err) { console.error(err); }
}

// ECOUTER LE SIGNAL DE MISE A JOUR
window.addEventListener('message', (event) => {
  if (event.data.action === 'refreshData') {
    loadTraces();
  }
});

loadTraces();
</script>
</body>
</html>